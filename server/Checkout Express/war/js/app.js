var mvc=mvc||{};!function(){"use strict";function e(){n||(n=!0,$("#feedback-page .ratings").on("click","a",function(){var e,n=$(this);e=n.hasClass("bad")?-1:n.hasClass("ok")?0:n.hasClass("just")?1:2,$("#feedback-page .ratings a").addClass("not-picked"),n.removeClass("not-picked"),ajax.send("cx","rate",{mobileKey:mvc.key(),clientID:mvc.clientID(),rating:e},$.noop,buildAjaxErrFun("send rating"))})),$("#feedback-page")[(mvc.done()?"add":"remove")+"Class"]("not-done")}var n=!1;mvc.addDoneListener(e),mvc.buildFeedback=e}();var mvc=mvc||{};!function(){"use strict";function e(){o=0!=$("#login-page .info .email input").val().length&&0!=$("#login-page .info .password input").val().length&&(!l[0].checked||0!=$("#login-page .info .confirm-password input").val().length),$("#login-page .confirm")[(o?"remove":"add")+"Class"]("disabled")}function n(){return o}function t(){var n=l[0].checked;$("#login-page .info").addClass(n?"register":"login"),$("#login-page .info").removeClass(n?"login":"register"),$("#login-page .confirm").text(n?"Register":"Login"),window.onresize(),e()}function i(){function n(e){c[0].checked=e,l[0].checked=!e,t()}null==c&&(c=$("#login-page .lor .login input"),l=$("#login-page .lor .register input"),$("#login-page .lor .login").click(n.c(!0)),$("#login-page .lor .register").click(n.c(!1)),$("#login-page .info input").keydown(e),$("#login-page .info input").keyup(e),$("#login-page .info input").keypress(e),$("#login-page .agreements > a").click(function(){r=window.onkeydown,window.onkeydown=function(e){13==e.keyCode&&$("#login-page .agreements .agree:visible").click()},$("#login-page .agreements .popup."+$(this).attr("class")).addClass("display")}),$("#login-page .agreements .agree").click(function(){window.onkeydown=r,r=null,$(this).parent().parent().removeClass("display")}),$("#login-page .agreements .disagree").click(function(){window.onkeydown=r,r=null,mvc.err("You must agree to both the Terms of Use and the Privacy Policy in order to use this app.")})),mvc.unbuild=function(){null!=r&&(window.onkeydown=r)},t()}function a(e){function n(n){t.addClass("loading"),ajax.send("user",n,{username:i,password:a},function(n){t.removeClass("loading"),mvc.username(i),mvc.cards(JSON.parse(n)),e()},buildAjaxErrFun(n))}var t=$("#login-page .confirm");if(!t.hasClass("loading")){var i=$("#login-page .info .email input").val(),a=$("#login-page .info .password input").val();isEmail(i)?l[0].checked?a.length<6?alert("Password is too short"):/^[0-9]*$/.test(a)&&a.length<30?alert("Password is not strong enough.  Either make it very long or add symbols/letters"):/^[a-zA-Z]*$/.test(a)&&a.length<20?alert("Password is not strong enough.  Either make it very long or add symbols/numbers"):/^[a-zA-Z0-9]*$/.test(a)&&a.length<16?alert("Password is not strong enough.  Either make it longer or add symbols"):a!=$("#login-page .info .confirm-password input").val()?alert("Passwords do not match"):n("register"):n("login"):alert("The email address you entered is invalid")}}var o,c=null,l=null,r=null;mvc.buildLogin=i,mvc.completeLogin=n,mvc.login=a}();var mvc={};!function(){"use strict";var e=["key","clientID","items","split","selection","tip","username","cards","paid","done","err"],n={};e.forEach(function(e){function t(t){callAll(i,arguments.length>0?t:n[e])}var i=[],a=e.charAt(0).toUpperCase()+e.substr(1);mvc[e]=function(i){if(0==arguments.length)return n[e];var a=n[e];n[e]=i,t(a),window.onresize()},mvc["add"+a+"Listener"]=function(e){i.push(e)},mvc["notify"+a]=op.call.c(t)}),mvc.init=function(){for(var t=0;t<e.length;t++)n[e[t]]=arguments[t]},mvc.processedSplit=function(){var e=mvc.split();if(null==e)return null;var n={};for(var t in e)for(var i=0;i<e[t].length;i++){var a=e[t][i];n[a]=(n[a]||0)+1}return n},mvc.processedItems=function(e,n){var t=[];t.subtotal=0,t.tax=0,t.discount=0,t.serviceCharge=0;for(var i=mvc.items(),a=mvc.processedSplit(),o=mvc.selection(),c=0;c<i.length;c++){var l=i[c],r=l.id;if((!e||null==a||o[r])&&(l.paidNum<l.paidDenom||n)){var s=l.paidDenom-l.paidNum,p=l.paidDenom*(1+(e&&a&&a[r]||0)),d=Math.gcd(s,p);s/=d,p/=d;var m=(l.price||0)*s/p/100,u=(l.tax||0)*s/p/100,v=(l.discount||0)*s/p/100,g=(l.serviceCharge||0)*s/p/100;t.push({id:r,num:s,denom:p,name:(1==p?"":"("+s+"/"+p+") ")+l.name,price:money.round(m),tax:money.round(u),discount:money.round(v),serviceCharge:money.round(g),mods:l.mods});for(var f=0;f<l.mods.length;f++)m+=(l.mods[f].price||0)*s/p/100;t.subtotal+=m,t.tax+=u,t.discount+=v,t.serviceCharge+=g}}return t.subtotal=money.round(t.subtotal),t.tax=money.round(t.tax),t.discount=money.round(t.discount),t.serviceCharge=money.round(t.serviceCharge),t}}(),function(){"use strict";function e(){var e=$(window),n=Math.floor(.92*e.width()/26),t=$("body");if(0!=t.size()){t.css("font-size",n+"px");var i=$("#footer img"),a=8>n||n>24?null:Math.ceil(2.5*n);i.attr("src","img/cx"+(n>24?"":"_"+(a||20))+".png"),null==a?i.removeAttr("style"):i.css("height",a+"px");var o=$("#pay-page img.ssl"),c=o.height();o.attr("src","img/ssl_"+(c>=55?"58":c>=37?"52":"22")+".png"),t.removeClass("tall"),Math.max(t.get(0).scrollHeight,$("html").get(0).scrollHeight)<=Math.min(t.get(0).clientHeight,$("html").get(0).clientHeight)&&t.addClass("tall"),$(".popup").css("font-size",Math.min(e.width()/28.4,e.height()/24)+"px")}}function n(n,t){if((mvc.paid()||mvc.done())&&n!=p)return l();if(window.location.hash!="#"+s[n]&&(window.location.hash="#"+s[n]),!$("body").hasClass(s[n]+"-page")){r&&n!=p&&ajax.send("cx","log_pos",{position:n,mobileKey:mvc.key(),clientID:mvc.clientID},$.noop,buildAjaxErrFun("contact the server")),null!=mvc.unbuild&&(mvc.unbuild(),mvc.unbuild=null);for(var i=0;i<s.length;i++)n==i?$("body").addClass(s[i]+"-page"):$("body").removeClass(s[i]+"-page");null!=t&&t.apply(mvc),e()}}function t(){null!=mvc.split()?i():n(0)}function i(){n(1,mvc.buildSplit)}function a(){null==mvc.split()||mvc.validSplit()?n(2,mvc.buildReceipt):t()}function o(){null==mvc.tip()||null!=mvc.split()&&!mvc.validSplit()?t():n(3,mvc.buildLogin)}function c(){null==mvc.tip()||0==mvc.username().length||null!=mvc.split()&&!mvc.validSplit()?t():n(4,mvc.buildPay)}function l(){mvc.paid()||mvc.done()?n(p,mvc.buildFeedback):t()}var r=!1;window.onresize=e;var s=["ask-split","split","receipt","login","pay","feedback"],p=s.indexOf("feedback");window.onload=function(){$("body").addClass("has-js"),socket.load(),window.onhashchange(),$("#ask-split-page a.yes").click(i),$("#ask-split-page a.no").click(a),$("#split-page a.confirm").click(function(){mvc.validSplit()?a():null==mvc.selection()||$.isEmptyObject(mvc.selection())?alert("Tap on the items you which to pay for"):alert("Before you can proceed, everyone must select the items they are paying for.  This means that your friends need to take out their phone and scan the code or enter the URL just as you have done")}),$("#receipt-page a.confirm").click(function(){null!=mvc.tip()?0==mvc.username().length?o():c():alert("Please enter a tip")}),$("#login-page a.confirm").click(function(){mvc.completeLogin()?mvc.login(c):alert("The login/register information you entered is incomplete")}),$("#pay-page .login a").click(o),$("#pay-page a.confirm").click(function(){mvc.completePayment()?mvc.pay(l):alert("The payment information you entered is incomplete")}),window.onkeydown=function(e){13==e.keyCode&&$(".confirm:visible").click()},r=!0};var d=!1;window.onunload=window.onbeforeunload=function(){null!=mvc.err()||d||(d=!0,ajax.send("cx","close",{clientID:mvc.clientID()}))},window.onhashchange=function(){var e=window.location.hash;switch(e.length>0&&(e=e.slice(1)),s.indexOf(e)){case 1:i();break;case 2:a();break;case 3:o();break;case 4:c();break;case 5:l();break;default:t()}},mvc.addSplitListener(function(e){mvc.done()||null==mvc.split()||null!=e&&mvc.validSplit()||(mvc.tip(null),i())}),mvc.addPaidListener(function(){mvc.paid()&&l()}),mvc.addDoneListener(function(){mvc.done()&&l()}),mvc.addItemsListener(function(){0==mvc.items().length&&(mvc.done(!0),l())}),mvc.addErrListener(function(){function e(){$("body").addClass("error-page");var e=mvc.err();$("body").html(null!=template["cxErr__"+e]?template["cxErr__"+e]():template.cxErr(e)),document.title="Checkout Express - Error: "+e,window.onhashchange=function(){window.location.hash.length>0&&(window.location.hash="")},window.onhashchange(),ajax.send("cx","close",{clientID:mvc.clientID(),error:e},$.noop)}0==$("body").size()?window.onload=e:(e(),socket.close())})}();var mvc=mvc||{};!function(){"use strict";function e(){return l}function n(){$("#pay-page .cards").val()==s.text()?($("#pay-page").addClass("new-cc-needed"),l=$("#pay-page .pan input").val().length>=8&&$("#pay-page .name input").val().length>=2&&$("#pay-page .expr-year input").val().length>=2&&$("#pay-page .cvv input").val().length>=1&&$("#pay-page .zip input").val().length>=5):($("#pay-page").removeClass("new-cc-needed"),l=!0),window.onresize(),$("#pay-page .confirm")[(l?"remove":"add")+"Class"]("disabled")}function t(){window.onkeydown=p,p=null,$("#pay-page .cvv").removeClass("help-needed")}function i(){p=window.onkeydown,window.onkeydown=t,$("#pay-page .cvv").addClass("help-needed")}function a(){if(null!=s){r={};var e=s.parent();e.empty();var t=mvc.cards();t.sort(function(e,n){return e.lastUse-n.lastUse});for(var i=null,a=0;a<t.length;a++){for(var o=t[a],c=o.prefix;c.length<o.len-4;)c+="X";c+=(o.lastFour<10?"   ":o.lastFour<100?"  ":o.lastFour<1e3?" ":"")+o.lastFour,r[c]=o.uuid,e.append($(template.cxCC(c))),0==a&&(i=c)}e.append(s),null!=i&&e.val(i),n()}}function o(){null==s&&(s=$("#pay-page .REPLACE-ME").siblings(),a(),$("#pay-page select").keydown(n),$("#pay-page input").keydown(n),$("#pay-page select").keyup(n),$("#pay-page input").keyup(n),$("#pay-page select").keypress(n),$("#pay-page input").keypress(n),$("#pay-page select").change(n),$("#pay-page input").change(n),$("#pay-page .cvv .explanation > a").click(i),$("#pay-page .cvv .infographic").click(t),$("#pay-page .cvv .infographic > div").click(function(e){e.stopPropagation()}),$("#pay-page .cvv .infographic a").click(t)),mvc.unbuild=function(){null!=p&&(window.onkeydown=p)}}function c(e){function n(n){for(var i=[],a=[],o=[],c=mvc.processedItems(!0),l=0;l<c.length;l++){var r=c[l];i.push(r.id),a.push(r.num),o.push(r.denom)}ajax.send("cx","pay",{mobileKey:mvc.key(),clientID:mvc.clientID(),cardUUID:n,items:i,nums:a,denoms:o,total:c.subtotal+c.tax-c.discount+c.serviceCharge,tip:mvc.tip()},function(n){t.removeClass("loading"),n=JSON.parse(n),mvc.done(n.done),mvc.paid(!0),e()},buildAjaxErrFun("pay"))}var t=$("#login-page .confirm");if(!t.hasClass("loading"))if(t.addClass("loading"),$("#pay-page .cards").val()==s.text()){var i=$("#pay-page .pan input").val().trim();ajax.send("user","add_cc",{PAN:i,name:$("#pay-page .name input").val().trim(),exprYear:$("#pay-page .expr-year input").val().trim(),exprMonth:parseInt($("#pay-page .expr-month select").val().trim().substr(0,2).trim()),CVV:$("#pay-page .cvv input").val().trim(),zip:$("#pay-page .zip input").val().trim()},function(e){e=e.trim();var t=mvc.cards(),a=t.length&&t[0].prefix.length;t.splice(0,0,{prefix:i.substr(0,a),lastFour:i.substr(-4),uuid:e,len:i.length}),mvc.notifyCards(),n(e)},buildAjaxErrFun("add a credit card"))}else n(r[$("#pay-page .cards").val()])}var l,r,s=null,p=null;mvc.addCardsListener(a),mvc.addUsernameListener(function(){$("#pay-page .username").text(mvc.username())}),mvc.buildPay=o,mvc.completePayment=e,mvc.pay=c}();var mvc=mvc||{};!function(){"use strict";function e(){o=o||$("#receipt-page .tipPrct");var e=mvc.tip();if($("#receipt-page .tip .percent").removeClass("not-picked"),null==e)o.text(""),$("#receipt-page .confirm").addClass("disabled");else{$("#receipt-page .tip .percent").addClass("not-picked");var n="other";if($("#receipt-page .confirm").removeClass("disabled"),e>=1e6*a)o.text("Thank you!");else if(e>=1e4*a)o.text("("+Math.round(e/a)+"x)");else if(e>=10*a)o.text("("+Math.round(100*e/a)+"%)");else{var t=Math.round(1e4*e/a)/100,i=Math.min(1,Math.max(.1,100/a));t>15-i&&15+i>t?n="fifteen":t>17-i&&17+i>t?n="seventeen":t>20-i&&20+i>t&&(n="twenty"),o.text("("+t+"%)")}$("#receipt-page .tip ."+n).removeClass("not-picked")}}function n(){l=l||$("#receipt-page .REPLACE-ME").parent();var n=mvc.processedItems(!0);a=n.subtotal,l.empty();for(var t=0;t<n.length;t++){var i=n[t];l.append($(template.cxReceiptItem(i.name,money.toStr(i.price),i.mods.map(function(e){return template.cxItemMod(e.name,0==e.price?"":money.toStr(e.price))}).join(""),"")))}var o=template.cxReceiptItem("","--------","","divider");l.append($(o)),l.append($(template.cxReceiptItem("Subtotal",money.toStr(a),"","subtotal"))),0!=n.discount&&l.append($(template.cxReceiptItem("Discount",money.toStr(-n.discount),"","discount"))),0!=n.serviceCharge&&l.append($(template.cxReceiptItem("Service Charge",money.toStr(n.serviceCharge),"","service-charge"))),l.append($(template.cxReceiptItem("Tax",money.toStr(n.tax),"","tax"))),l.append($(o)),a+=n.tax-n.discount+n.serviceCharge,l.append($(template.cxReceiptItem("Total",money.toStr(a),"","total"))),e()}function t(){var e=c.val();e!=r&&(e.match(/^[0-9]*\.?[0-9]{0,2}$/)?(r=e,mvc.tip(0==e.length||"."==e?null:Math.round(100*parseFloat(e)))):c.val(r))}function i(){function e(e){c.val(money.toStr(money.round(a*e/100),"")),t()}s||(n(),c=$("#receipt-page .tip input"),$("#receipt-page .tip .percent.fifteen").click(e.c(15)),$("#receipt-page .tip .percent.seventeen").click(e.c(17)),$("#receipt-page .tip .percent.twenty").click(e.c(20)),$("#receipt-page .tip .percent.other").click(function(){c.val(money.toStr(Math.round([200,a/4].max()),"")),t()}),c.keyup(t),c.keydown(t),c.keypress(t),t(),s=!0)}var a,o,c,l=null,r="",s=!1;mvc.addItemsListener(n),mvc.addSplitListener(n),mvc.addSelectionListener(n),mvc.addTipListener(e),mvc.buildReceipt=i}();var socket=socket||{};!function(){"use strict";function e(e){l=e}function n(){r=new goog.appengine.Channel(l).open({onopen:t,onmessage:i,onerror:a,onclose:o}),r.onopen=t,r.onmessage=i,r.onerror=a,r.onclose=o}function t(){}function i(e){e=e.data.trim().split("\n");var n=e[0].trim().toUpperCase();void 0==s[n]?mvc.err('Unknown command "'+n+'" from channel'):s[n].apply(this,e.slice(1))}function a(e){0==e.code&&(null==e.description||0==e.description.trim().length)&&(e.description="Either the server or your phone seems to have turned off"),mvc.err("Channel error #"+e.code+": "+e.description)}function o(){}function c(){null!=r&&(r.close(),r=null)}var l,r=null,s={ITEMS_AND_REMOVE_SPLIT:function(e,n){mvc.items(JSON.parse(e)),null!=mvc.split()&&(delete mvc.split()[n],mvc.notifySplit())},SPLIT:function(e,n){var t=JSON.parse(n);null==t?null!=mvc.split()&&delete mvc.split()[e]:(null==mvc.split()&&mvc.split({}),mvc.split()[e]=t),mvc.notifySplit()},START_SPLIT:function(){null==mvc.split()?mvc.split({}):mvc.notifySplit()},ERR:function(){mvc.err(Array.prototype.join.call(arguments,"\n"))},DONE:function(){mvc.done(!0)}};socket.init=e,socket.load=n,socket.close=c}(),function(){"use strict";function e(e,n,t,i,a){n=n||{},n.mobileKey=mvc.key(),n.clientID=mvc.clientID(),ajax.send("cx/split",e,n,t,i,a)}function n(){var n=$(this).attr("itemID"),t=mvc.selection();e((t[n]=!t[n])?"add":"remove",{itemID:n}),mvc.notifySelection()}function t(){p||(p=!0,$("#split-page .items").on("click","a",n),a()),null==mvc.split()&&(mvc.split({}),e("start"))}function i(e){var n=r[e],t=null!=mvc.selection()&&!!mvc.selection()[e],i=null==mvc.split()?0:mvc.processedSplit()[e]||0,a=n.mods.map(function(e){return template.cxItemMod(e.name,e.price?money.toStr(e.price):"")}).join(""),o=$(template.cxSplitItem(e,t,i,n.name,money.toStr(n.price),a));null!=s[e]&&s[e].replaceWith(o),s[e]=o}function a(){var e=mvc.processedItems();if(0!=e.length){var n=null;if(null==s)n=$("#split-page .REPLACE-ME");else for(var t in s)null==n?n=s[t]:s[t].remove();s={};var a=[];r={};for(var o=0;o<e.length;o++){var t=e[o].id;r[t]=e[o],i(t),a.push(t)}n.replaceWith(a.map(function(e){return s[e].get(0)})),l()}}function o(){for(var e in r)i(e);l()}function c(){if(null==r)return null==mvc.processedSplit();var e=mvc.selection()||{},n=mvc.processedSplit()||{};for(var t in r)if(!e[t]&&!n[t])return!1;return!0}function l(){$("#split-page .confirm")[(c()?"remove":"add")+"Class"]("disabled")}var r=null,s=null,p=!1;mvc.addItemsListener(a),mvc.addSplitListener(o),mvc.addSelectionListener(o),mvc.buildSplit=t,mvc.validSplit=c}();